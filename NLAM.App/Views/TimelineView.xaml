<UserControl x:Class="NLAM.App.Views.TimelineView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:NLAM.App.Views"
             xmlns:converters="clr-namespace:NLAM.App.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="300" d:DesignWidth="800"
             PreviewMouseWheel="Timeline_PreviewMouseWheel">
    <UserControl.Resources>
        <converters:TimeToPixelsConverter x:Key="TimeToPixelsConverter"/>
        <converters:BoolToOutlineBrushConverter x:Key="BoolToOutlineBrushConverter"/>
        <converters:BoolToOutlineThicknessConverter x:Key="BoolToOutlineThicknessConverter"/>
    </UserControl.Resources>
    <Grid Background="{StaticResource PanelBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header with length -->
            <RowDefinition Height="30"/> <!-- Ruler -->
            <RowDefinition Height="*"/>  <!-- Tracks -->
            <RowDefinition Height="Auto"/> <!-- Footer with Add Macro button -->
        </Grid.RowDefinitions>

        <!-- Timeline Header -->
        <Border Grid.Row="0" Background="{StaticResource WindowBackgroundBrush}" Padding="5,3">
            <Grid>
                <TextBlock Text="Timeline" FontWeight="Bold" Foreground="{StaticResource PrimaryTextBrush}" VerticalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <TextBlock Text="Length: " Foreground="{StaticResource PrimaryTextBrush}" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding TotalLengthFormatted}" Foreground="{StaticResource AccentBrush}" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <Button Content="âš™" Width="22" Height="22" Click="SetLength_Click" ToolTip="Set Timeline Length" FontSize="10"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Time Ruler Container - syncs with tracks scroll -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="150"/> <!-- Fixed header space -->
                <ColumnDefinition Width="*"/>   <!-- Scrollable ruler area -->
            </Grid.ColumnDefinitions>
            
            <!-- Header spacer -->
            <Border Grid.Column="0" Background="{StaticResource WindowBackgroundBrush}"/>
            
            <!-- Scrollable ruler area (clips to show only visible portion) -->
            <Canvas x:Name="TimeRuler" Grid.Column="1" Background="{StaticResource BorderBrush}" ClipToBounds="True" Loaded="TimeRuler_Loaded">
                <!-- Ruler ticks will be drawn dynamically -->
            </Canvas>
        </Grid>

        <!-- Tracks Area -->
        <ScrollViewer x:Name="TracksScrollViewer" Grid.Row="2" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" ScrollChanged="TracksScrollViewer_ScrollChanged">
            <Grid>
                <ItemsControl ItemsSource="{Binding Tracks}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Height="{Binding Height}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Background="{StaticResource PanelBackgroundBrush}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/> <!-- Header -->
                                        <ColumnDefinition Width="*"/>   <!-- Content -->
                                    </Grid.ColumnDefinitions>

                                    <!-- Track Header -->
                                    <Border Grid.Column="0" Background="{StaticResource WindowBackgroundBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0">
                                        <Border.ContextMenu>
                                            <ContextMenu Tag="{Binding}">
                                                <MenuItem Header="Rename Track..." Click="RenameTrack_Click"/>
                                                <Separator/>
                                                <MenuItem Header="Move Track Up" Click="MoveTrackUp_Click"/>
                                                <MenuItem Header="Move Track Down" Click="MoveTrackDown_Click"/>
                                                <Separator/>
                                                <MenuItem Header="Delete Track" Click="DeleteTrack_Click"/>
                                            </ContextMenu>
                                        </Border.ContextMenu>
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Margin="10,0" Foreground="{StaticResource PrimaryTextBrush}"/>
                                    </Border>

                                    <!-- Track Content (Clips) -->
                                    <ItemsControl Grid.Column="1" ItemsSource="{Binding Clips}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas ClipToBounds="True">
                                                    <Canvas.Width>
                                                        <MultiBinding Converter="{StaticResource TimeToPixelsConverter}">
                                                            <Binding Path="DataContext.TotalLength" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.ZoomLevel" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.ViewportWidth" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.TotalLength" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        </MultiBinding>
                                                    </Canvas.Width>
                                                </Canvas>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left">
                                                    <Setter.Value>
                                                        <MultiBinding Converter="{StaticResource TimeToPixelsConverter}">
                                                            <Binding Path="StartTime"/>
                                                            <Binding Path="DataContext.ZoomLevel" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.ViewportWidth" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.TotalLength" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        </MultiBinding>
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter Property="Width">
                                                    <Setter.Value>
                                                        <MultiBinding Converter="{StaticResource TimeToPixelsConverter}">
                                                            <Binding Path="Duration"/>
                                                            <Binding Path="DataContext.ZoomLevel" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.ViewportWidth" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                            <Binding Path="DataContext.TotalLength" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        </MultiBinding>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <Thumb DragDelta="Clip_DragDelta" DragStarted="Clip_DragStarted" Tag="{Binding}" PreviewMouseDown="Clip_MouseDown" AllowDrop="True">
                                                        <Thumb.ContextMenu>
                                                            <ContextMenu Opened="ClipContextMenu_Opened">
                                                                <MenuItem Header="Edit AHK Script..." Click="EditScript_Click"/>
                                                                <Separator/>
                                                                <MenuItem Header="Pick Color..." Click="PickColor_Click"/>
                                                                <MenuItem Header="Duplicate Clip" Click="DuplicateClip_Click"/>
                                                                <MenuItem Header="Move to Track" x:Name="MoveToTrackMenu"/>
                                                                <Separator/>
                                                                <MenuItem Header="Delete Clip" Click="DeleteClip_Click"/>
                                                            </ContextMenu>
                                                        </Thumb.ContextMenu>
                                                        <Thumb.Template>
                                                            <ControlTemplate>
                                                                <Border x:Name="ClipBorder" Background="{Binding Color}" CornerRadius="3" Height="40" VerticalAlignment="Center"
                                                                        BorderBrush="{Binding IsSelected, Converter={StaticResource BoolToOutlineBrushConverter}}"
                                                                        BorderThickness="{Binding IsSelected, Converter={StaticResource BoolToOutlineThicknessConverter}}">
                                                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" FontSize="10"/>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Thumb.Template>
                                                    </Thumb>
                                                    <!-- Resize Handle -->
                                                    <Thumb Width="8" HorizontalAlignment="Right" Cursor="SizeWE" DragDelta="ClipResize_DragDelta" Tag="{Binding}">
                                                        <Thumb.Template>
                                                            <ControlTemplate>
                                                                <Border Background="Transparent"/>
                                                            </ControlTemplate>
                                                        </Thumb.Template>
                                                    </Thumb>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Playhead Overlay -->
                <!-- We need to offset by the Header Width (150) -->
                <Canvas IsHitTestVisible="False" Margin="150,0,0,0">
                    <Border Width="2" Background="Red" VerticalAlignment="Stretch" Height="1000">
                        <Canvas.Left>
                            <MultiBinding Converter="{StaticResource TimeToPixelsConverter}">
                                <Binding Path="CurrentTime"/>
                                <Binding Path="ZoomLevel"/>
                                <Binding Path="ViewportWidth"/>
                                <Binding Path="TotalLength"/>
                            </MultiBinding>
                        </Canvas.Left>
                    </Border>
                </Canvas>
            </Grid>
        </ScrollViewer>

        <!-- Footer with Add Macro Button -->
        <Border Grid.Row="3" Background="{StaticResource WindowBackgroundBrush}" Padding="5,3">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="+ Add Track" Click="AddTrack_Click" Padding="8,3" Margin="0,0,5,0" ToolTip="Add a new track"/>
                <Button Content="+ Add Macro" Click="AddMacro_Click" Padding="8,3" ToolTip="Add a new macro clip" Background="{StaticResource AccentBrush}" Foreground="White"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
